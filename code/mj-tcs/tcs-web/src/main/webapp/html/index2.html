<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>MJ TCS Client</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" type="text/css" href="../css/animate.css"/>
        <!--<link rel="stylesheet" href="../css/font-awesome/css/font-awesome.min.css"/>-->
        <style>
            body > div > div {
                margin: 10px;
                padding: 5px;
                border: dashed 1px #777;
            }
        </style>

        <script src="../js/jquery-1.11.3.js"></script>

        <script src="../plugin/noty/packaged/jquery.noty.packaged.min.js"></script>

        <script src="../plugin/sockjs/sockjs.js"></script>
        <script src="../plugin/stomp/stomp.min.js"></script>
        <script defer="defer" type="text/javascript">
            var URL = "http://localhost:8080/stomp";
            var ACTIONS = {
                           // Scene
                           SCENE_PROFILE :"SCENE_PROFILE",
                           SCENE_CREATE :"SCENE_CREATE",
                           SCENE_FIND :"SCENE_FIND",
                           SCENE_DELETE :"SCENE_DELETE",
                           SCENE_START :"SCENE_START",
                           SCENE_STOP :"SCENE_STOP",
                           SCENE_SPECIFIC_PROFILE :"SCENE_SPECIFIC_PROFILE",
                           // Transport Order
                           TO_NEW: "TO_NEW",
                           TO_WITHDRAW: "TO_WITHDRAW",
                           // Vehicle
                           VEHICLE_PROFILE: "VEHICLE_PROFILE",
                           VEHICLE_ADAPTER_ATTACH: "VEHICLE_ADAPTER_ATTACH",
                           VEHICLE_DISPATCH: "VEHICLE_DISPATCH",
                           VEHICLE_STOP_TO: "VEHICLE_STOP_TO",
                           VEHICLE_PARK: "VEHICLE_PARK"
            };
            var REQ_UUID = uuid();
//            var wsUrl = "ws://localhost:8080/tcs-web/tcs-web";
            var stompClient = null;
            var req_action = null;
            var adapterMap = new Map();
            var subscriberMap = new Map();// sceneId -> subscriberLists

            function sceneIdChange() {
                var sceneId = $("#findSceneId").val();
                $("#vehicleSceneId").html("<b>SceneID: </b>" + sceneId);
                $("#transportSceneId1").html("<b>SceneID: </b>" + sceneId);
                $("#transportSceneId2").html("<b>SceneID: </b>" + sceneId);

                // update subscribers for the new scene
                if (subscriberMap.has(sceneId)) {
                    var prevSubscribers = subscriberMap.get(sceneId);
                    for (var i = 0; i < prevSubscribers.length; i++) {
                        prevSubscribers[i].unsubscribe();
                    }
                    subscriberMap.clear();
                }

                // add new subscribers
                var transportSubscriber = stompClient.subscribe("/topic/status/scenes/" + sceneId+"/torders",
                        function(message) {
//                            var response = JSON.parse(message.body);
                            console.log("++++++++++++++++");
//                            console.log(message.body);

                            document.getElementById('transportStatus').innerHTML = "<b>TransportOrder:</b><br>" + message.body;
                        });

                var vehicleSubscriber = stompClient.subscribe("/topic/status/scenes/" + sceneId+"/vehicles",
                        function(message) {
//                            var response = JSON.parse(message.body);
                            console.log("---------------");
//                            console.log(message.body);
                            document.getElementById("vehicleStatus").innerHTML = "<b>VehicleStatus:</b><br>" + message.body;
                        });

                subscriberMap.set(sceneId, [transportSubscriber, vehicleSubscriber]);
            };

            function setConnected(connected) {
                document.getElementById('connect').disabled = connected;
                document.getElementById('disconnect').disabled = !connected;
            }

            function connect() {
                var socket = new SockJS(URL);
                stompClient = Stomp.over(socket);

                stompClient.heartbeat.outgoing = 10000; // client will send heartbeats every 10000ms
                stompClient.heartbeat.incoming = 0; // client does not want to receive heartbeats from the server

                stompClient.connect({}, function(frame) {
                    setConnected(true);
                    console.log('Connected: ' + frame);

                    stompClient.subscribe("/user/topic/actions/response", function(message) {
                        var response = JSON.parse(message.body);
                        document.getElementById('response').innerHTML = "<b>Response:</b><br><br>" + message.body;

                        if (response.uuid == REQ_UUID) {
                            var status = response.status_code.toLocaleLowerCase();
                            var message = '<h6>' + response.status_message + '</h6>' + JSON.stringify(response.body);
                            generate(status, message);

                            $('#content').html("<b>Status Code:</b>&nbsp" + response.status_code + "<br>" +
                                    "<b>Status Message:</b>&nbsp" + response.status_message + "<br>" +
//                                        "<b>Action Code:</b>&nbsp" + response.action_code + "<br><br>" +
                                    "<b>Body:</b>" + JSON.stringify(response.body));
                        } else if (response.uuid == (REQ_UUID + "_PROFILE")) {
                            var contentList = response.body;
                            var currentVehicleUUID = $('#vehicleUUID').val();
                            // collect adapters for all vehicles
                            var currentVehicleIndex = -1;
                            adapterMap.clear();
                            for(var i=0; i < contentList.length; i++) {
                                adapterMap.set(contentList[i].uuid, contentList[i].adapters);
                                if (contentList[i].uuid == currentVehicleUUID) {
                                    currentVehicleIndex = i;
                                }
                            }

                            var domVehicleAdapters = $("#vehicleAdapters");
                            domVehicleAdapters.empty();
                            domVehicleAdapters.append("<option value=''></option>");

                            // add adapter options for the specified vehicle
                            if (adapterMap.has(currentVehicleUUID)) {
                                var adapters = adapterMap.get(currentVehicleUUID);
                                for (var i=0; i<adapters.length; i++) {
                                    domVehicleAdapters.append("<option value='" + adapters[i] + "'>"  + adapters[i] +"</option>");
                                }
                                // select the default value
                                domVehicleAdapters.val(contentList[currentVehicleIndex].adapter);

                                // update Enable checkbox
                                $("#enableAdapter").prop("checked", contentList[currentVehicleIndex].enable == "true");

                                // update PointUUID
                                $("#vehiclePointUUID").val(contentList[currentVehicleIndex].position_uuid);
                            }

                        } else {
                                generate('error', 'Received irrelevant message ! <br><p>' + message.body + '</p>')
                        }
                    });

                    stompClient.subscribe("/user/queue/errors", function(message) {
                        generate("error", message.body);
                    });

                });
            }

            function disconnect() {
                if (stompClient != null) {
                    stompClient.unsubscribe();
                    stompClient.disconnect();
                }
                setConnected(false);
                console.log("Disconnected");
            }

            function clearResponse() {
                document.getElementById("response").innerText = "";
            }

            function getScenesProfile() {
                fireAction(ACTIONS.SCENE_PROFILE);
            }

            function createScene() {
                var newName = $('#newSceneName').val();
                var body = {"id":null,"version":null,"name":newName,"properties":[{"name":"key","value":"value","type":"java.lang.String"}],"UUID":"scenedto-b2796efe-ab5f-44b1-aae9-6e16fedf1ccc",
                    "points":[{"id":null,"version":null,"name":"test_point_0","properties":[],"vehicle_orientation_angle":0.0,"type":"HALT_POSITION","attached_links":[{"UUID":"locationlinkdto-94836d25-29fc-44a0-911d-86014dfac8ca"}],"UUID":"pointdto-6949b047-97fa-4104-818b-56a5b5c4066e","position":{"x":658,"y":482,"z":0},"display_position_x":658,"display_position_y":482,"label_offset_x":0,"label_offset_y":20,"incoming_paths":[],"outgoing_paths":[{"UUID":"pathdto-b9066c29-ce55-4b79-b2ee-baa8999658ef"}]},{"id":null,"version":null,"name":"test_point_1","properties":[],"vehicle_orientation_angle":0.0,"type":"HALT_POSITION","attached_links":[],"UUID":"pointdto-eacd255a-9bf2-4848-bc65-cdbac41352c5","position":{"x":827,"y":264,"z":0},"display_position_x":827,"display_position_y":264,"label_offset_x":0,"label_offset_y":20,"incoming_paths":[{"UUID":"pathdto-b9066c29-ce55-4b79-b2ee-baa8999658ef"}],"outgoing_paths":[]},{"id":null,"version":null,"name":"test_point_2","properties":[],"vehicle_orientation_angle":0.0,"type":"HALT_POSITION","attached_links":[],"UUID":"pointdto-9fae4650-88fd-4731-bc0a-c4e29c2cc2fe","position":{"x":346,"y":61,"z":0},"display_position_x":346,"display_position_y":61,"label_offset_x":0,"label_offset_y":20,"incoming_paths":[],"outgoing_paths":[]}],
                    "paths":[{"id":null,"version":null,"name":"test_path_0","properties":[],"control_points":[],"length":426,"routing_cost":1,"max_velocity":1.0,"max_reverse_velocity":1.0,"locked":false,"UUID":"pathdto-b9066c29-ce55-4b79-b2ee-baa8999658ef","source_point":{"UUID":"pointdto-6949b047-97fa-4104-818b-56a5b5c4066e"},"destination_point":{"UUID":"pointdto-eacd255a-9bf2-4848-bc65-cdbac41352c5"}}],
                    "locations":[{"id":null,"version":null,"name":"test_location_3785","properties":[],"attached_links":[{"id":null,"version":null,"name":"test_link_3785","allowed_operations":[],"UUID":"locationlinkdto-94836d25-29fc-44a0-911d-86014dfac8ca","point":{"UUID":"pointdto-6949b047-97fa-4104-818b-56a5b5c4066e"}}],"UUID":"locationdto-0206deb6-919c-4911-b1c2-5989655c2b30","position":{"x":100,"y":100,"z":0},"location_type":{"UUID":"locationtypedto-ec1c05be-153a-4e0b-9314-724c0ab03ae4"},"display_position_x":100,"display_position_y":100,"label_offset_x":0,"label_offset_y":20}],
                    "location_types":[{"id":null,"version":null,"name":"test_lt_174","properties":[],"allowed_operations":["Puts in storage","Stock removal"],"UUID":"locationtypedto-ec1c05be-153a-4e0b-9314-724c0ab03ae4"}],
                    "blocks":[{"id":null,"version":null,"name":"test_block_2435","properties":[],"members":[{"UUID":"pointdto-6949b047-97fa-4104-818b-56a5b5c4066e"},{"UUID":"pointdto-eacd255a-9bf2-4848-bc65-cdbac41352c5"},{"UUID":"pathdto-b9066c29-ce55-4b79-b2ee-baa8999658ef"},{"UUID":"locationdto-0206deb6-919c-4911-b1c2-5989655c2b30"}],"UUID":"blockdto-37ea38b3-3b15-4b16-b5bb-d7742d806461"}],
                    "static_routes":[{"id":null,"version":null,"name":"test_static_route_6979","properties":[],"hops":[{"UUID":"pointdto-6949b047-97fa-4104-818b-56a5b5c4066e"},{"UUID":"pointdto-eacd255a-9bf2-4848-bc65-cdbac41352c5"},{"UUID":"pointdto-9fae4650-88fd-4731-bc0a-c4e29c2cc2fe"}],"UUID":"staticroutedto-1711913e-fd02-4a8c-80e4-43255d7f7a26"}],
                    "vehicles":[{"id":null,"version":null,"name":"test_vehicle_2403","properties":[],"length":1000.0,"energy_level":80.0,"energy_level_critical":30.0,"energy_level_good":80.0,"recharge_operation":"RECHARGE","max_velocity":100.0,"max_reverse_velocity":100.0,"initial_point":null,"orientation_angle":0.0,"UUID":"vehicledto-69cb85f1-9aea-4470-8ce2-c19edbef1c38","precise_position":null},
                        {"id":null,"version":null,"name":"test_vehicle_2403","properties":[],"length":1000.0,"energy_level":80.0,"energy_level_critical":30.0,"energy_level_good":80.0,"recharge_operation":"RECHARGE","max_velocity":100.0,"max_reverse_velocity":100.0,"initial_point":null,"orientation_angle":0.0,"UUID":"vehicledto-69cb85f1-9aea-4470-8ce2-c19edbef1c37","precise_position":null}]};

                fireAction(ACTIONS.SCENE_CREATE, body);
            }

            function getVehicleProfile() {
                var request = {
                    "uuid":REQ_UUID + "_PROFILE", // SPECIAL !!!
                    "action_code":ACTIONS.VEHICLE_PROFILE,
                    "body": {}
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/vehicles/request", {},
                        JSON.stringify(request));
            }

            function attachAdapter() {
                var request = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.VEHICLE_ADAPTER_ATTACH,
                    "body": [{
                        "vehicle_uuid": $("#vehicleUUID").val(),
                        "adapter_name": $("#vehicleAdapters").val(),
                        "initial_position_uuid": $("#vehiclePointUUID").val(),
                        "enable": $("#enableAdapter").prop("checked")
                    }]
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/vehicles/request", {},
                        JSON.stringify(request));
            }

            function dispatchVehicle() {
                var request = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.VEHICLE_DISPATCH,
                    "body": $("#vehicleUUID").val()
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/vehicles/request", {},
                        JSON.stringify(request));
            }

            function parkVehicle() {
                var request = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.VEHICLE_PARK,
                    "body": $("#vehicleUUID").val()
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/vehicles/request", {},
                        JSON.stringify(request));
            }

            function stopVehicle() {
                var request = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.VEHICLE_STOP_TO,
                    "body": {
                        "uuid":$("#vehicleUUID").val(),
                        "disable_vehicle":$("#disableVehicle").prop("checked")
                    }
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/vehicles/request", {},
                        JSON.stringify(request));
            }

            function createTransport() {

                var transport = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.TO_NEW,
                    "body":{
                        "uuid":REQ_UUID,
                        "deadline":null,
                        "intended_vehicle":null,
                        "destinations":[
                            {
                                "location_uuid":$("#locationName1").val(),
                                "operation":$("#operation1").val()
                            }
                        ],
                        "dependencies":[]
                    }
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/torders/request", {},
                        JSON.stringify(transport));
            }

            function withdrawTransport() {

                var transportWithdraw = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.TO_WITHDRAW,
                    "body":{
                        "uuid":$("#transportOrderUUID").val(),
                        "force":$("#forceWithdraw").prop("checked"),
                        "disable_vehicle":$("#disableVehicle").prop("checked")
                    }
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/torders/request", {},
                        JSON.stringify(transportWithdraw));
            }

            function getScene() {
                fireAction(ACTIONS.SCENE_FIND, Number($("#findSceneId").val()));
            }

            function getSceneProfile() {

                var sceneProfile = {
                    "uuid":REQ_UUID,
                    "action_code":ACTIONS.SCENE_SPECIFIC_PROFILE,
                    "body":{}
                };

                stompClient.send("/app/topic/actions/scenes/" + Number($("#findSceneId").val()) + "/request", {},
                        JSON.stringify(sceneProfile));
            }

            function deleteScene() {
                fireAction(ACTIONS.SCENE_DELETE, Number($("#findSceneId").val()));
            }

            function startScene() {
                fireAction(ACTIONS.SCENE_START, Number($("#findSceneId").val()));
            }

            function stopScene() {
                fireAction(ACTIONS.SCENE_STOP, Number($("#findSceneId").val()));
            }

            function fireAction(action, body) {
                stompClient.send("/app/topic/actions/request", {},
                        JSON.stringify({uuid:REQ_UUID,action_code:action,body:body}));
            }

            function uuid() {
                var s = [];
                var hexDigits = "0123456789abcdef";
                for (var i = 0; i < 36; i++) {
                    s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
                }
                s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
                s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
                s[8] = s[13] = s[18] = s[23] = "-";

                var uuid = s.join("");
                return uuid;
            }

            /**
             *
             * @param type
             *        alert, warning, success, error, information
             * @param text
             *
             */
            function generate(type, text) {
                // Refer to: http://www.yeahzan.com/fa/facss.html
                var icon_style = "fa-info-circle";
                switch (type) {
                    case 'alert':
                        icon_style = "fa-flash";
                        break;
                    case 'warning':
                        icon_style = "fa-warning";
                        break;
                    case 'success':
                        icon_style = "fa-heart";
                        break;
                    case 'error':
                        icon_style = "fa-minus";
                        break;
                    case 'information':
                        icon_style = "fa-info-circle";
                        break;
                }

                var new_text = '<div class="activity-item"> <i class="fa '
                        + icon_style
                        + '"></i>'
                        + '<div class="activity">'
                        + text
                        + '</div> </div>';

                var n = noty({
                    text        : new_text,
                    type        : type, // 消息类型
                    dismissQueue: true, // 使用序列
                    layout      : 'bottomRight', // 显示的位置
                    theme       : 'relax', // 使用的主题
                    template    : '<div class="noty_message"><span class="noty_text"></span><div class="noty_close"></div></div>',
                    maxVisible  : 10,
                    modal: false,
                    maxVisible: 5, // 可以设置最多显示多少个通知消息
                    killer: false, // 在显示这个noty之前，将所有的noty关掉
                    closeWith: ['click'], // 关闭的方式，默认是click['click', 'button', 'hover']
                    killer: false, // 在显示这个noty之前，将所有的noty关掉
                    timeout     : 60000, // 60 seconds fade out
                    animation   : {
                        open  : 'animated bounceInRight',
                        close : 'animated fadeOut',
                        easing: 'swing',
                        speed : 500
                    },
                    callback: {     // 设置回调函数
                        onShow: function() {},
                        afterShow: function() {},
                        onClose: function() {},
                        afterClose: function() {}
                    },
                    buttons: false // 定义一个按钮数组
                });
                console.log('html: ' + n.options.uuid);
            }

            // TESTING ONLY !!!
//            // notification body's can be any html string or just string
//            var notification_html = [];
//            notification_html[0] = 'There are <a href="#">6 new tasks</a> waiting for you. Don\'t forget! <span>About 3 hours ago</span>',
//            notification_html[1] = 'Mail server was updated. See <a href="#">changelog</a> <span>About 2 hours ago</span>',
//            notification_html[2] = 'Your <a href="#">latest post</a> was liked by <a href="#">Audrey Mall</a> <span>35 minutes ago</span>',
//            notification_html[3] = '<a href="#">Eugene</a> ordered 2 copies of <a href="#">OEM license</a> <span>14 minutes ago</span>';
//
//            function generateAll() {
//                generate('warning', notification_html[0]);
//                generate('error', notification_html[1]);
//                generate('information', notification_html[2]);
//                generate('success', notification_html[3]);
////            generate('notification');
////            generate('success');
//            }
//
//            $(document).ready(function () {
//
//                setTimeout(function() {
//                    generateAll();
//                }, 500);
//
//            });
        </script>
    </head>
    <body>
        <div>
            <div>
                <button id="connect" onclick="connect();">Connect</button>
                <button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
                <button id="clear" onclick="clearResponse();">Clear Content</button>
            </div>
            <div>
                <b>New Scene Name:</b>
                <input id="newSceneName" type="text" name="sceneName" value="scene_01" style="width: 80px"/>
                <button id="createScene" style="width: 100px;height: 100%;" onclick="createScene()">Create Scene</button>
            </div>
            <div>
                <button id="sceneProfiles" onclick="getScenesProfile();">Scene Profile</button>
                <b>Scene ID:</b>
                <input id="findSceneId" onkeyup="sceneIdChange()" type="text" name="sceneId" value="" style="width: 30px"/>
                <button id="getScene" style="width: 100px; height: 100%;" onclick="getScene()">Get Scene</button>
                <button id="getSceneProfile" style="width: 150px; height: 100%;" onclick="getSceneProfile()">Get Scene Profile</button>
                <button id="deleteScene" style="width: 100px; height: 100%;" onclick="deleteScene()">Delete Scene</button>
                <button id="startScene" style="width: 100px;height: 100%;" onclick="startScene()">Start Scene</button>
                <button id="stopScene" style="width: 100px;height: 100%;" onclick="stopScene()">Stop Scene</button>
            </div>
            <div>
                <span id="vehicleSceneId"></span>
                <button id="vehicleProfile" style="width: 100px;height: 100%;" onclick="getVehicleProfile()">Vehicle Profile</button>
                <b>Vehicle UUID:</b><input id="vehicleUUID" type="text" name="vehicleUUID" value="" style="width: 250px"/>
                <p>
                    <label>Select Adapter</label>
                    <select id = "vehicleAdapters" style="width: 200px;">
                        <option value = ""></option>
                    </select>
                    <label><input id="enableAdapter" type="checkbox" value="" />Enable</label>
                    <b>PointUUID:</b><input id="vehiclePointUUID" type="text" value="" style="width: 250px;height: 100%;"/>
                    <button id="setAdapter"onclick="attachAdapter()">Set Adapter</button>
                </p>
                <button id="vehicleDispatch" style="width: 150px;height: 100%;" onclick="dispatchVehicle()">Dispatch Vehicle</button>
                <button id="vehiclePark" style="width: 150px;height: 100%;" onclick="parkVehicle()">Park Vehicle</button>
                <button id="vehicleStop" style="width: 150px;height: 100%;" onclick="stopVehicle()">Stop Vehicle</button>
            </div>
            <div>
                <span id="transportSceneId1"></span>
                <b>Location UUID:</b><input id="locationName1" type="text" name="locationName1" value="" style="width: 250px"/>
                <b>Operation:</b><input id="operation1" type="text" name="operation1" value="NOP" style="width: 80px"/>
                <button id="createTransport" style="width: 150px;height: 100%;" onclick="createTransport()">Create Transport</button>
            </div>
            <div>
                <span id="transportSceneId2"></span>
                <b>TransportOrder UUID:</b><input id="transportOrderUUID" type="text" name="transportOrderUUID" value="" style="width: 250px"/>
                <label><input id="disableVehicle" type="checkbox" value="" />Disable Vehicle</label>
                <label><input id="forceWithdraw" type="checkbox" value="" />forceWithdraw</label>
                <button id="withdrawTransport" style="width: 150px;height: 100%;" onclick="withdrawTransport()">Withdraw Transport</button>
            </div>
            <div id="transportStatus" style="height: 80px;">
            </div>
            <div id="vehicleStatus" style="height: 80px">
            </div>
            <div id="response" style="height: 500px;"/>
        </div>

    </body>
</html>
